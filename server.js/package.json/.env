// server.js
require('dotenv').config();
const express = require('express');
const fetch = require('node-fetch'); // npm i node-fetch@2
const path = require('path');
const rateLimit = require('express-rate-limit');

const app = express();
const PORT = process.env.PORT || 3000;
const OPENAI_KEY = process.env.OPENAI_API_KEY;
const MODEL = process.env.MODEL_NAME || 'gpt-4o-mini'; // cámbialo si quieres otro modelo

if(!OPENAI_KEY){
  console.error('ERROR: configura OPENAI_API_KEY en .env');
  process.exit(1);
}

app.use(express.json());
app.use(express.static('public'));

// rate limiting básico
const limiter = rateLimit({
  windowMs: 15*60*1000, // 15 minutos
  max: 120
});
app.use(limiter);

// Filtro simple para bloquear peticiones peligrosas
const blockedPatterns = [
  /exploit/i, /hack/i, /cheat/i, /ddos/i, /bypass/i, /crack/i,
  /steal/i, /account\s*password/i, /token/i, /backdoor/i
];

function isBlocked(text){
  return blockedPatterns.some(rx => rx.test(text));
}

// System prompt: acota el dominio y formato de respuesta
const systemPrompt = `
Eres un asistente experto en Roblox Studio y Luau (lenguaje Luau). 
Responde solo sobre Roblox Studio, instancias, APIs de Roblox, scripting Luau, buenas prácticas, optimización, debugging y diseño de juegos en Roblox.
- Devuelve ejemplos de código en bloques de código con la etiqueta \`\`\`lua
- Explica los pasos y por qué funcionan
- Si la pregunta es sobre exploits, hacks, robo de cuentas, bypass de seguridad o actividades ilegales, recházala con un mensaje conciso indicando por qué y ofrece alternativas legítimas (por ejemplo: mejores prácticas, cómo reportar exploits a Roblox).
- Si falta contexto (por ejemplo: estructura del proyecto), pide la información mínima necesaria, pero hazlo de forma breve.
- Evita respuestas que promuevan comportamiento inseguro o violen las normas de Roblox.
- Identifícate brevemente al inicio: "Asistente Roblox/Luau — " seguido de la respuesta.
`;

// Endpoint para chat
app.post('/api/chat', async (req, res) => {
  try{
    const { message } = req.body;
    if(!message || typeof message !== 'string') return res.status(400).json({ error: 'Mensaje vacío' });

    if(isBlocked(message)){
      return res.status(403).json({
        error: 'No puedo ayudar con exploits, hacks, robo de cuentas o actividades ilegales. Puedo ayudar con buenas prácticas y cómo reportar vulnerabilidades a Roblox.'
      });
    }

    // Build the messages array
    const messages = [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: message }
    ];

    // Call OpenAI Chat Completions
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${OPENAI_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: MODEL,
        messages,
        max_tokens: 800,
        temperature: 0.1,
        top_p: 1,
        n: 1
      })
    });

    if(!response.ok){
      const t = await response.text();
      console.error('OpenAI error', response.status, t);
      return res.status(502).json({ error: 'Error desde la API de OpenAI' });
    }

    const data = await response.json();
    const answer = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || 'No hay respuesta';
    res.json({ answer });
  }catch(err){
    console.error(err);
    res.status(500).json({ error: 'Error del servidor' });
  }
});

// fallback: sirve index.html
app.get('*', (req,res)=> res.sendFile(path.resolve(__dirname, 'public/index.html')));

app.listen(PORT, ()=> console.log(`Servidor en http://localhost:${PORT}`));

{
  "name": "roblox-luau-assistant",
  "version": "1.0.0",
  "description": "Asistente especializado en Roblox Studio y Luau (demo).",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "dependencies": {
    "dotenv": "^16.0.0",
    "express": "^4.18.2",
    "express-rate-limit": "^6.7.0",
    "node-fetch": "^2.6.7"
  },
  "devDependencies": {
    "nodemon": "^2.0.22"
  }
}
npm install


